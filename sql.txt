-- Создайте таблицы (упростённо)
create table users (
  id uuid primary key default gen_random_uuid(),
  username text unique not null,
  avatar text,
  password text not null
);

create table servers (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  owner_id uuid references users(id),
  invite_code text unique
);

create table server_members (
  id uuid primary key default gen_random_uuid(),
  server_id uuid references servers(id),
  user_id uuid references users(id)
);

create table channels (
  id uuid primary key default gen_random_uuid(),
  server_id uuid references servers(id),
  name text not null,
  type text not null default 'text'
);

create table messages (
  id uuid primary key default gen_random_uuid(),
  server_id uuid references servers(id),
  channel_id uuid references channels(id),
  user_id uuid references users(id),
  username text,
  avatar text,
  content text,
  created_at timestamptz default now()
);

//storage policy

CREATE POLICY "Allow public upload to avatars with userId"
ON storage.objects
FOR INSERT
TO public
WITH CHECK (
  bucket_id = 'avatars' AND
  name LIKE 'avatars/%'  -- Убедимся, что путь начинается с avatars/
);

CREATE POLICY "Public read avatars"
ON storage.objects
FOR SELECT
TO public
USING (bucket_id = 'avatars');

CREATE POLICY "Allow public update avatars"
ON storage.objects
FOR UPDATE
TO public
USING (bucket_id = 'avatars')
WITH CHECK (bucket_id = 'avatars' AND name LIKE 'avatars/%');